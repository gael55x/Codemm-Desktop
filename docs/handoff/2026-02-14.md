# Handoff: 2026-02-14

## Summary

- Added deterministic, enforceable quality gates to prevent “hard”/advanced problems from being accepted with weak/non-discriminative tests.
- Enforced Java OOP structural topic promises (when requested) with deterministic validators.
- Made planner assign multiple topics for hard slots to encourage interacting constraints (deterministically).
- Prevented silent intent downgrade via commitments-aware fallback policy + UI-visible progress event.
- Locked per-problem constraints to slot constraints to eliminate constraint drift.
- Updated/modernized integration tests to match the desktop local-only DB model (threads/activities; no users/community).

## Iteration Log

### Iteration 1 (Reliability Enforcement: Quality Gates + Contracts)

- Added deterministic Test Strength Gate that runs baseline incorrect implementations via the existing judge adapter after reference validation; if any baseline passes, the slot fails deterministically (`apps/backend/src/generation/testStrengthGate.ts`, `apps/backend/src/generation/index.ts`).
- Added Java structural topic validators for OOP topics (polymorphism/inheritance/abstraction/encapsulation/composition) and wired them into generation so violations trigger contract repair (`apps/backend/src/languages/java/structuralTopics.ts`, `apps/backend/src/generation/perSlotGenerator.ts`).
- Updated planner to assign 2 topics per slot for hard difficulty when multiple topic tags exist (deterministic, preserves slot order) (`apps/backend/src/planner/index.ts`).
- Made generation fallback intent-preserving via commitments-aware policy (disallow hard→medium or topic narrowing when locked) and emit a progress event so the UI can surface fallbacks (`apps/backend/src/agent/generationFallback.ts`, `apps/backend/src/services/sessionService.ts`, `apps/backend/src/contracts/generationProgress.ts`, `apps/frontend/src/types/generationProgress.ts`, `apps/frontend/src/app/page.tsx`).
- Locked `constraints` to `slot.constraints` and deterministically rejects LLM-provided constraint mismatches to prevent drift (`apps/backend/src/generation/perSlotGenerator.ts`).

### Iteration 2 (Tests + Desktop DB Alignment)

- Added unit + integration tests for the new gates/validators/retry behavior (gate failures are deterministic and mapped to a distinct failure kind) (`apps/backend/test/unit/*`, `apps/backend/test/integration/languages/hardIntentWeakTestsBlocked.test.js`).
- Updated integration tests to match desktop local-only persistence (`threads`/`activities`; no `userDb`, no community routes) and ensured generated drafts satisfy the required examples contract (`sample_inputs`/`sample_outputs` non-empty) (`apps/backend/test/integration/*`).

## How to Run

- Backend tests: `cd Codemm-IDE/apps/backend && npm test`
- Focused integration: `cd Codemm-IDE/apps/backend && node scripts/runTests.js integration languages`

## Known Issues / Next

- Real-LLM + Docker matrix tests require API keys and prebuilt judge images (`apps/backend/test/integration/llm/*`).
